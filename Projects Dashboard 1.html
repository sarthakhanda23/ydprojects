<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOGIJI DIGI – Planning Dashboard</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', 'Open Sans', sans-serif;
            background-color: #1a1a1a; /* Secondary color */
            color: #cccccc; /* Light gray text */
        }
        
        /* Custom card style */
        .dashboard-card {
            background-color: #2a2a2a; /* Slightly lighter charcoal */
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Custom red gradient button */
        .btn-red-gradient {
            background-image: linear-gradient(to right, #a20000, #c00000);
            transition: all 0.3s ease;
        }
        .btn-red-gradient:hover {
            background-image: linear-gradient(to right, #c00000, #a20000);
            box-shadow: 0 0 15px rgba(162, 0, 0, 0.5);
        }

        /* Table header sort icons */
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            color: #ffffff;
        }
        .sort-icon {
            display: inline-block;
            margin-left: 8px;
            opacity: 0.5;
        }
        .sortable-header.asc .sort-icon,
        .sortable-header.desc .sort-icon {
            opacity: 1;
        }
        .sortable-header.asc .sort-icon::after {
            content: ' ▲';
        }
        .sortable-header.desc .sort-icon::after {
            content: ' ▼';
        }
        
        /* Chart.js tooltip */
        .chartjs-tooltip {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 6px;
            padding: 6px 10px;
        }
        
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a20000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Top Navbar -->
    <nav class="bg-[#1a1a1a] shadow-lg sticky top-0 z-50 border-b border-[#333]">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo Placeholder -->
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-white text-2xl font-bold tracking-wider">YOGIJI DIGI</span>
                </div>
                
                <!-- Navigation Items -->
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#" class="text-white font-semibold px-3 py-2 text-sm rounded-md border-b-2 border-[#a20000]">Dashboard</a>
                        <a href="#" class="text-[#cccccc] hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-300">Projects</a>
                        <a href="#" class="text-[#cccccc] hover:text-white px-3 py-2 rounded-md text-sm font-medium transition duration-300">Reports</a>
                    </div>
                </div>
                
                <!-- Mobile Menu Button (optional but good for responsiveness) -->
                <div class="-mr-2 flex md:hidden">
                    <button type="button" class="bg-[#333] inline-flex items-center justify-center p-2 rounded-md text-[#cccccc] hover:text-white hover:bg-[#444] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                        <span class="sr-only">Open main menu</span>
                        <!-- Icon for menu (hamburger) -->
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Content -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- 1. KPI Cards Section -->
        <section class="mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- KPI Card: Total Projects -->
                <div class="dashboard-card p-5 border-l-4 border-[#a20000] transform transition-transform duration-300 hover:scale-105">
                    <h3 class="text-sm font-medium text-[#cccccc] uppercase tracking-wider">Total Projects</h3>
                    <p id="kpi-total-projects" class="mt-2 text-3xl font-bold text-white">0</p>
                </div>
                
                <!-- KPI Card: Total Billing Value -->
                <div class="dashboard-card p-5 border-l-4 border-[#a20000] transform transition-transform duration-300 hover:scale-105">
                    <h3 class="text-sm font-medium text-[#cccccc] uppercase tracking-wider">Total Billing Value</h3>
                    <p id="kpi-total-billing" class="mt-2 text-3xl font-bold text-white">₹0</p>
                </div>
                
                <!-- KPI Card: Completed Dispatches -->
                <div class="dashboard-card p-5 border-l-4 border-[#a20000] transform transition-transform duration-300 hover:scale-105">
                    <h3 class="text-sm font-medium text-[#cccccc] uppercase tracking-wider">Completed Dispatches</h3>
                    <p id="kpi-completed" class="mt-2 text-3xl font-bold text-white">0</p>
                </div>
                
                <!-- KPI Card: Pending Dispatches -->
                <div class="dashboard-card p-5 border-l-4 border-[#a20000] transform transition-transform duration-300 hover:scale-105">
                    <h3 class="text-sm font-medium text-[#cccccc] uppercase tracking-wider">Pending Dispatches</h3>
                    <p id="kpi-pending" class="mt-2 text-3xl font-bold text-white">0</p>
                </div>
            </div>
        </section>

        <!-- 2. Charts & AI Section -->
        <section class="flex flex-wrap lg:flex-nowrap gap-6">
            
            <!-- Left Column: Charts -->
            <div class="w-full lg:w-2/3 flex flex-col gap-6">
                <!-- Bar & Pie Charts Row -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <!-- Bar Chart: Billing by PM -->
                    <div class="dashboard-card p-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Billing Value by Project Manager</h3>
                        <canvas id="pmBarChart"></canvas>
                    </div>
                    
                    <!-- Pie Chart: Dispatch Status -->
                    <div class="dashboard-card p-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Dispatch Status Distribution</h3>
                        <div class="max-h-80 relative flex justify-center">
                            <canvas id="statusPieChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Line Chart: Billing Trend -->
                <div class="dashboard-card p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Billing Value Trend by Dispatch Month</h3>
                    <canvas id="billingLineChart"></canvas>
                </div>
            </div>
            
            <!-- Right Column: AI Insight Box -->
            <div class="w-full lg:w-1/3">
                <div class="dashboard-card p-6 h-full flex flex-col sticky top-24">
                    <h3 class="text-xl font-semibold text-white mb-4">AI-Powered Insights</h3>
                    <p class="text-sm text-[#cccccc] mb-4">Ask a question about the data. (e.g., "Summarize billing for Aditya Sharma" or "Which project has the highest pending value?")</p>
                    
                    <textarea id="aiQuery" class="w-full bg-[#1a1a1a] text-white p-3 rounded-md border border-[#444] focus:ring-2 focus:ring-[#a20000] focus:border-[#a20000] focus:outline-none" rows="4" placeholder="Type your query..."></textarea>
                    
                    <button id="analyzeButton" class="w-full mt-4 p-3 font-semibold text-white rounded-lg btn-red-gradient focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#2a2a2a] focus:ring-[#a20000]">
                        Analyze
                    </button>
                    
                    <div class="mt-4 flex-grow bg-[#1a1a1a] rounded-md p-4 border border-[#444] overflow-y-auto min-h-[150px]">
                        <div id="aiLoading" class="hidden items-center justify-center h-full">
                            <div class="loader"></div>
                        </div>
                        <div id="aiResult" class="text-[#cccccc] whitespace-pre-wrap">Your insights will appear here...</div>
                    </div>
                </div>
            </div>
            
        </section>

        <!-- 3. Table Section -->
        <section class="mt-6">
            <div class="dashboard-card p-6">
                <h3 class="text-xl font-semibold text-white mb-4">All Project Data</h3>
                
                <!-- Search Bar -->
                <div class="mb-4">
                    <input id="tableSearch" type="text" placeholder="Search projects, PMs, status..." class="w-full md:w-1/3 bg-[#1a1a1a] text-white p-2 rounded-md border border-[#444] focus:ring-2 focus:ring-[#a20000] focus:border-[#a20000] focus:outline-none">
                </div>
                
                <!-- Data Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-[#333]">
                                <th class="p-3 sortable-header asc" data-column="PROJECT">Project <span class="sort-icon"></span></th>
                                <th class="p-3 sortable-header" data-column="PM">PM <span class="sort-icon"></span></th>
                                <th class="p-3 sortable-header" data-column="ASSEMBLY">Assembly <span class="sort-icon"></span></th>
                                <th class="p-3 sortable-header" data-column="BILLING VALUE (Rs.)">Billing Value <span class="sort-icon"></span></th>
                                <th class="p-3 sortable-header" data-column="DISPATCH STATUS">Dispatch Status <span class="sort-icon"></span></th>
                                <th class="p-3 sortable-header" data-column="DISPATCH MONTH">Dispatch Month <span class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody id="projectTableBody">
                            <!-- Rows will be injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div id="paginationControls" class="mt-4 flex flex-col md:flex-row justify-between items-center text-sm">
                    <span id="pageInfo" class="mb-2 md:mb-0"></span>
                    <div>
                        <button id="prevPage" class="bg-[#444] hover:bg-[#555] text-white font-medium py-2 px-4 rounded-l-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <button id="nextPage" class="bg-[#444] hover:bg-[#555] text-white font-medium py-2 px-4 rounded-r-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script type="module">
        // --- DATA ---
        // Mock data embedded to simulate reading "Sheet1" without an upload.
        // This is based on the snippets and common data patterns.
        const pms = ["ADITYA SHARMA", "ADITYA SAINI", "MAYANK", "SACHIN", "SAURABH", "SHRIYANSH", "SACHIN TB"];
        const projects = ["2207-JTL-6HI", "2404-GOPANI-SPM", "2414-UTTAM-6HI", "2522-APL-SPM", "2506-JSW-APL", "2301-ABC-PROJ", "2302-XYZ-PROJ"];
        const assemblies = ["Fume exhaust duct", "Cellar Ventilation duct", "WR ROLL-2NOS", "WR CHOCKS -4 NOS", "TOP PLATEFORM", "HOOD ASSY", "AC MOTOR -3 Motor", "UNCOILER-O.B.B.S ASSY", "RECOILER-O.B.B.S ASSY", "PEELER TABLE ASSY.", "Entry seal with Tunnel", "PASSING TABLE", "PIPES & FITTINGS", "SPARE-SPINDLE COUPLING"];
        const statuses = ["Dispatched", "Not Dispatched", "Pending Inspection", "In Production", "Cancelled"];
        const months = ["October", "November", "December", "January", "February", "March"];

        const actualData = [
            { "PROJECT": "2207-JTL-6HI CRM", "PM": "ADITYA SHARMA", "ASSEMBLY": "Fume exhaust duct", "BILLING VALUE (Rs.)": 850000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2207-JTL-6HI CRM", "PM": "ADITYA SHARMA", "ASSEMBLY": "Cellar Ventilation duct", "BILLING VALUE (Rs.)": 500000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2404-GOPANI-4HI SPM", "PM": "ADITYA SHARMA", "ASSEMBLY": "WR ROLL-2NOS", "BILLING VALUE (Rs.)": 600000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2404-GOPANI-4HI SPM", "PM": "ADITYA SHARMA", "ASSEMBLY": "WR CHOCKS -4 NOS", "BILLING VALUE (Rs.)": 1200000, "DISPATCH STATUS": "Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2404-GOPANI-4HI SPM", "PM": "ADITYA SHARMA", "ASSEMBLY": "TOP PLATEFORM", "BILLING VALUE (Rs.)": 500000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2404-GOPANI-4HI SPM", "PM": "ADITYA SHARMA", "ASSEMBLY": "HOOD ASSY", "BILLING VALUE (Rs.)": 500000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2404-GOPANI-4HI SPM", "PM": "ADITYA SHARMA", "ASSEMBLY": "PIPES & FITTINGS", "BILLING VALUE (Rs.)": 2000000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2404-GOPANI-4HI SPM", "PM": "ADITYA SHARMA", "ASSEMBLY": "SPARE-SPINDLE COUPLING", "BILLING VALUE (Rs.)": 700000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2414-UTTAM-6HI CRM", "PM": "ADITYA SHARMA", "ASSEMBLY": "AC MOTOR -3 Motor", "BILLING VALUE (Rs.)": 29955000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2522-APL-SPM", "PM": "ADITYA SAINI", "ASSEMBLY": "UNCOILER-O.B.B.S ASSY", "BILLING VALUE (Rs.)": 500000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "December" },
            { "PROJECT": "2522-APL-SPM", "PM": "ADITYA SAINI", "ASSEMBLY": "RECOILER-O.B.B.S ASSY", "BILLING VALUE (Rs.)": 500000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "December" },
            { "PROJECT": "2522-APL-SPM", "PM": "ADITYA SAINI", "ASSEMBLY": "PEELER TABLE ASSY.", "BILLING VALUE (Rs.)": 600000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "December" },
            { "PROJECT": "2522-APL-SPM", "PM": "ADITYA SAINI", "ASSEMBLY": " EXIT THREADING TABLE ASSY.", "BILLING VALUE (Rs.)": 600000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "December" },
            { "PROJECT": "2522-APL-SPM", "PM": "ADITYA SAINI", "ASSEMBLY": "PASSING TABLE", "BILLING VALUE (Rs.)": 500000, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "December" },
            { "PROJECT": "2506-JSW-APL", "PM": "ADITYA SHARMA", "ASSEMBLY": "Entry seal with Tunnel", "BILLING VALUE (Rs.)": 0, "DISPATCH STATUS": "Not Dispatched", "DISPATCH MONTH": "December" },
            { "PROJECT": "2301-ABC-PROJ", "PM": "MAYANK", "ASSEMBLY": "WR CHOCKS -4 NOS", "BILLING VALUE (Rs.)": 2500000, "DISPATCH STATUS": "Dispatched", "DISPATCH MONTH": "November" },
            { "PROJECT": "2302-XYZ-PROJ", "PM": "SACHIN", "ASSEMBLY": "HOOD ASSY", "BILLING VALUE (Rs.)": 4800000, "DISPATCH STATUS": "Dispatched", "DISPATCH MONTH": "October" },
            { "PROJECT": "2301-ABC-PROJ", "PM": "MAYANK", "ASSEMBLY": "TOP PLATEFORM", "BILLING VALUE (Rs.)": 750000, "DISPATCH STATUS": "In Production", "DISPATCH MONTH": "January" },
            { "PROJECT": "2506-JSW-APL", "PM": "SAURABH", "ASSEMBLY": "Fume exhaust duct", "BILLING VALUE (Rs.)": 1200000, "DISPATCH STATUS": "Pending Inspection", "DISPATCH MONTH": "November" },
        ];
        
        let generatedData = [];
        for (let i = 0; i < 180; i++) { // Generate ~180 more rows for a total of 200
            generatedData.push({
                "PROJECT": `${projects[Math.floor(Math.random() * projects.length)]}-${i+1000}`,
                "PM": pms[Math.floor(Math.random() * pms.length)],
                "ASSEMBLY": assemblies[Math.floor(Math.random() * assemblies.length)],
                "BILLING VALUE (Rs.)": Math.floor(Math.random() * 4000000) + 200000,
                "DISPATCH STATUS": statuses[Math.floor(Math.random() * statuses.length)],
                "DISPATCH MONTH": months[Math.floor(Math.random() * months.length)]
            });
        }
        
        const allData = [...actualData, ...generatedData];

        // --- GLOBAL STATE ---
        let allCharts = {}; // To store chart instances for destruction
        let currentPage = 1;
        const rowsPerPage = 10;
        let currentSort = { column: 'PROJECT', order: 'asc' };
        let currentFilteredData = [...allData];

        // --- FORMATTERS ---
        const formatCurrency = (value) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(value);
        const formatCompact = (value) => new Intl.NumberFormat('en-IN', { notation: 'compact', maximumFractionDigits: 2 }).format(value);

        // --- CORE FUNCTIONS ---
        
        /**
         * Main function to initialize or update the entire dashboard.
         */
        function updateDashboard(data) {
            updateKPIs(data);
            renderPmBarChart(data);
            renderStatusPieChart(data);
            renderBillingLineChart(data);
            
            // Set up table state and render first page
            currentFilteredData = filterData(data);
            currentPage = 1;
            renderTable();
        }

        /**
         * Update the 4 KPI cards.
         */
        function updateKPIs(data) {
            const totalProjects = new Set(data.map(d => d.PROJECT)).size;
            const totalBilling = data.reduce((acc, d) => acc + d['BILLING VALUE (Rs.)'], 0);
            const completed = data.filter(d => d['DISPATCH STATUS'] === 'Dispatched').length;
            const pending = data.filter(d => d['DISPATCH STATUS'] !== 'Dispatched').length;
            
            document.getElementById('kpi-total-projects').innerText = totalProjects;
            document.getElementById('kpi-total-billing').innerText = '₹' + formatCompact(totalBilling);
            document.getElementById('kpi-completed').innerText = completed;
            document.getElementById('kpi-pending').innerText = pending;
        }

        /**
         * Set global Chart.js defaults
         */
        function setChartDefaults() {
            Chart.defaults.color = '#cccccc';
            Chart.defaults.borderColor = '#444';
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.plugins.tooltip.enabled = true;
            Chart.defaults.plugins.tooltip.mode = 'index';
            Chart.defaults.plugins.tooltip.intersect = false;
            Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold' };
            Chart.defaults.plugins.tooltip.bodyFont = { size: 12 };
            Chart.defaults.plugins.tooltip.padding = 10;
            Chart.defaults.plugins.tooltip.cornerRadius = 6;
        }

        /**
         * Render Bar Chart: Billing by PM
         */
        function renderPmBarChart(data) {
            const pmBilling = data.reduce((acc, d) => {
                if (!acc[d.PM]) acc[d.PM] = 0;
                acc[d.PM] += d['BILLING VALUE (Rs.)'];
                return acc;
            }, {});
            
            const labels = Object.keys(pmBilling);
            const values = Object.values(pmBilling);
            
            const ctx = document.getElementById('pmBarChart').getContext('2d');
            if (allCharts.pmBar) allCharts.pmBar.destroy();
            
            allCharts.pmBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Billing Value',
                        data: values,
                        backgroundColor: 'rgba(162, 0, 0, 0.8)',
                        borderColor: '#a20000',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Billing: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#444' },
                            ticks: {
                                color: '#cccccc',
                                callback: value => '₹' + formatCompact(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#cccccc' }
                        }
                    }
                }
            });
        }

        /**
         * Render Pie Chart: Dispatch Status
         */
        function renderStatusPieChart(data) {
            const statusCounts = data.reduce((acc, d) => {
                const status = d['DISPATCH STATUS'];
                if (!acc[status]) acc[status] = 0;
                acc[status]++;
                return acc;
            }, {});

            const themeColors = ['#a20000', '#600000', '#cccccc', '#888888', '#1a1a1a'];
            
            const ctx = document.getElementById('statusPieChart').getContext('2d');
            if (allCharts.statusPie) allCharts.statusPie.destroy();
            
            allCharts.statusPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: themeColors,
                        borderColor: '#2a2a2a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#cccccc',
                                padding: 15,
                                boxWidth: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => ` ${context.label}: ${context.parsed}`
                            }
                        }
                    }
                }
            });
        }

        /**
         * Render Line Chart: Billing Trend by Month
         */
        function renderBillingLineChart(data) {
            const monthOrder = ["October", "November", "December", "January", "February", "March"];
            const monthBilling = data.reduce((acc, d) => {
                const month = d['DISPATCH MONTH'];
                if (monthOrder.includes(month)) {
                    if (!acc[month]) acc[month] = 0;
                    acc[month] += d['BILLING VALUE (Rs.)'];
                }
                return acc;
            }, {});
            
            const labels = monthOrder;
            const values = monthOrder.map(month => monthBilling[month] || 0);

            const ctx = document.getElementById('billingLineChart').getContext('2d');
            if (allCharts.lineChart) allCharts.lineChart.destroy();
            
            allCharts.lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Billing Value',
                        data: values,
                        borderColor: '#a20000',
                        backgroundColor: 'rgba(162, 0, 0, 0.2)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: '#a20000',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Billing: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#444' },
                            ticks: {
                                color: '#cccccc',
                                callback: value => '₹' + formatCompact(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#cccccc' }
                        }
                    }
                }
            });
        }

        // --- TABLE LOGIC ---

        /**
         * Filters the master data based on the search input.
         */
        function filterData(data) {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            if (!searchTerm) {
                return [...data];
            }
            return data.filter(row => {
                return Object.values(row).some(val => 
                    String(val).toLowerCase().includes(searchTerm)
                );
            });
        }

        /**
         * Sorts the data based on the current sort state.
         */
        function sortData(data) {
            const { column, order } = currentSort;
            return data.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                let comparison = 0;
                if (typeof valA === 'number' && typeof valB === 'number') {
                    comparison = valA - valB;
                } else {
                    comparison = String(valA).localeCompare(String(valB));
                }
                
                return comparison * (order === 'asc' ? 1 : -1);
            });
        }

        /**
         * Renders the table body and pagination controls.
         */
        function renderTable() {
            // 1. Filter
            currentFilteredData = filterData(allData);
            
            // 2. Sort
            sortData(currentFilteredData);
            
            // 3. Paginate
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = currentFilteredData.slice(startIndex, endIndex);
            
            // 4. Render Rows
            const tableBody = document.getElementById('projectTableBody');
            if (paginatedData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-[#888]">No matching data found.</td></tr>`;
            } else {
                tableBody.innerHTML = paginatedData.map(row => `
                    <tr class="border-b border-[#333] hover:bg-[#303030] transition duration-200">
                        <td class="p-3">${row.PROJECT}</td>
                        <td class="p-3">${row.PM}</td>
                        <td class="p-3">${row.ASSEMBLY}</td>
                        <td class="p-3 text-right">${formatCurrency(row['BILLING VALUE (Rs.)'])}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                row['DISPATCH STATUS'] === 'Dispatched' ? 'bg-green-800 text-green-200' :
                                row['DISPATCH STATUS'] === 'Not Dispatched' ? 'bg-red-800 text-red-200' :
                                row['DISPATCH STATUS'] === 'In Production' ? 'bg-blue-800 text-blue-200' :
                                'bg-yellow-800 text-yellow-200'
                            }">
                                ${row['DISPATCH STATUS']}
                            </span>
                        </td>
                        <td class="p-3">${row['DISPATCH MONTH']}</td>
                    </tr>
                `).join('');
            }
            
            // 5. Render Pagination Controls
            renderPaginationControls();
        }

        /**
         * Updates the pagination buttons and info text.
         */
        function renderPaginationControls() {
            const totalItems = currentFilteredData.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalItems);

            document.getElementById('pageInfo').innerText = 
                `Showing ${totalItems > 0 ? startIndex + 1 : 0} to ${endIndex} of ${totalItems} results`;
            
            document.getElementById('prevPage').disabled = (currentPage === 1);
            document.getElementById('nextPage').disabled = (currentPage === totalPages || totalItems === 0);
        }

        /**
         * Attach event listeners for table interactivity.
         */
        function setupTableListeners() {
            // Search
            document.getElementById('tableSearch').addEventListener('input', () => {
                currentPage = 1;
                renderTable();
            });
            
            // Sorting
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.column;
                    if (currentSort.column === column) {
                        currentSort.order = (currentSort.order === 'asc') ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.order = 'asc';
                    }
                    
                    // Update header classes
                    document.querySelectorAll('.sortable-header').forEach(h => {
                        h.classList.remove('asc', 'desc');
                        if (h.dataset.column === column) {
                            h.classList.add(currentSort.order);
                        }
                    });
                    
                    renderTable();
                });
            });
            
            // Pagination
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(currentFilteredData.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
        }
        
        // --- AI INSIGHTS LOGIC ---
        
        const aiButton = document.getElementById('analyzeButton');
        const aiResultEl = document.getElementById('aiResult');
        const aiLoadingEl = document.getElementById('aiLoading');

        /**
         * Fetches insights from the Gemini API with exponential backoff.
         */
        async function getAIInsights() {
            const userQuery = document.getElementById('aiQuery').value;
            if (!userQuery.trim()) {
                aiResultEl.innerText = "Please enter a query.";
                return;
            }

            aiButton.disabled = true;
            aiResultEl.classList.add('hidden');
            aiLoadingEl.classList.remove('hidden');
            aiLoadingEl.classList.add('flex'); // Make it flex to center the spinner
            
            const systemPrompt = `You are an expert planning and forecasting analyst for YOGIJI DIGI, an industrial manufacturing company. Your task is to analyze the provided JSON dataset snippet and answer the user's query. Be concise, professional, and data-driven. The dataset columns are: PROJECT, PM (Project Manager), ASSEMBLY, BILLING VALUE (Rs.), DISPATCH STATUS, DISPATCH MONTH. All currency values are in Indian Rupees (Rs.).`;
            
            // Send a snippet of the data for context
            const dataSnippet = JSON.stringify(allData.slice(0, 50)); // Send first 50 rows
            
            const fullPrompt = `
              User Query: "${userQuery}"
              
              JSON Data Snippet (first 50 rows):
              ${dataSnippet}
              
              Please analyze the data to answer the query.
            `;
            
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: fullPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const responseText = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                aiResultEl.innerText = responseText;

            } catch (error) {
                console.error('Error fetching AI insights:', error);
                aiResultEl.innerText = 'Error fetching insights. Please check the console and try again.';
            } finally {
                aiButton.disabled = false;
                aiLoadingEl.classList.add('hidden');
                aiLoadingEl.classList.remove('flex');
                aiResultEl.classList.remove('hidden');
            }
        }

        /**
         * A fetch wrapper with exponential backoff for API calls.
         */
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) { // Too Many Requests
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    console.warn('Unexpected API response structure:', result);
                    throw new Error(result.error?.message || 'Unexpected API response structure.');
                }
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        aiButton.addEventListener('click', getAIInsights);

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setChartDefaults();
            updateDashboard(allData);
            setupTableListeners();
        });

    </script>
</body>
</html>